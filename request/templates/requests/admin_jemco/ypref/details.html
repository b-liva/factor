{% extends 'requests/admin_jemco/page_elements/base_html/admin_base.html' %}
{% load humanize %}
{% load request_extras %}
{% block right_col %}
    <div class="container">
        <div class="row">
            <div id="customerDetails" class="col-md-3 col-sm-3 col-xs-12 col-xs-offset-0">
                <h3>{{ pref.req_id.customer }}</h3>
                <p><i class="fa fa-calendar" aria-hidden="true"></i> {{ pref.date_fa }}</p>
                <p><i class="fa fa-phone" aria-hidden="true"></i> {{ pref.req_id.customer.phone }}</p>
                <p><i class="fa fa-fax" aria-hidden="true"></i> {{ pref.req_id.customer.fax }}</p>
                <p><i class="fa fa-map-marker" aria-hidden="true"></i>
                    {{ pref.req_id.customer.address }}</p>
            </div>
            <div id="customerSummary" class=" col-md-6 col-sm-6 col-xs-12 ">
                <div class="animated flipInY col-lg-6 col-md-6 col-sm-6 col-xs-6">
                    <div class="tile-stats">
                        <div class="icon">
                        </div>
                        <span class="count">{{ pref.number }}</span>
                        <span class="{% if pref.perm %}green{% else %}red{% endif %}">{% if pref.perm %}(مجوز شده) {% else %}(مجوز نشده){% endif %}</span>

                        <h3>شماره پیشفاکتور</h3>
                    </div>
                </div>
                <div class="animated flipInY col-lg-6 col-md-6 col-sm-6 col-xs-6">
                    <div class="tile-stats">
                        <div class="icon">
                        </div>
                        <div class="count">{{ pref.exp_date_fa }}</div>

                        <h3>تاریخ انقضا</h3>
                    </div>
                </div>
                <div class="animated flipInY col-lg-6 col-md-6 col-sm-6 col-xs-6">
                    <div class="tile-stats">
                        <div class="icon col-md-6">
                            {#                        <i class="fa fa-usd" aria-hidden="true"></i>#}
                        </div>
                        <div class="count">${{ proforma_total|floatformat:0|intcomma }}</div>

                        <h3>مبلغ پیش فاکتور</h3>
                    </div>
                </div>
                {% if pref.perm %}
                    <div class="animated flipInY col-lg-6 col-md-6 col-sm-6 col-xs-6">
                        <div class="tile-stats">
                            <span class="count">${{ pref|perm_receivable|floatformat:0|intcomma }}</span>
                            <span class="red">(%{{ pref|receivable_percent|floatformat:2 }})</span>
                            <h3 class="col-xs-12">تسویه نشده</h3>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <div class="col-md-10 col-md-offset-1 col-sm-10 col-sm-offset-1 col-xs-12">
                {#                    Edit Buttons#}
                <div class="row">
                    <div class="pull-left">
                        {% if perms.request.add_xpref %}
                            <div>

                                <a class="btn btn-sm btn-success" href="{% url 'pro_form' %}">
                                    <i class="fa fa-plus" aria-hidden="true"></i>
                                    پیش فاکتور جدید</a>
                                <a class="btn btn-sm btn-info" href="{% url 'pref_index' %}">
                                    <i class="fa fa-list-ul" aria-hidden="true"></i>
                                    پیش فاکتورها</a>
                            </div>
                            <div>
                                <a class="btn btn-warning btn-sm pull-left" type="submit" name="submit"
                                   href="{% url 'pref_edit_form' ypref_pk=pref.pk %}">
                                    <i class="fa fa-pencil"></i> ویرایش قیمت</a>
                                <a class="btn btn-warning btn-sm pull-left"
                                   href="{% url 'pref_edit2' ypref_pk=pref.pk %}">
                                    <i class="fa fa-pencil"></i> ویرایش پیشفاکتور</a>
                            </div>
                        {% endif %}

                    </div>
                </div>
                <div style="margin-top: 150px">
                    <h4>جزئیات پیشفاکتور شماره {{ pref.number }} مربوط به درخواست شماره
                        <a class="badge badge-light"
                           href="{% url 'request_details' request_pk=pref.req_id.pk %}">{{ pref.req_id.number }}</a>
                    </h4>
                    {#                Table of specs#}
                    <div class="table-responsive">
                        <table class="table table-hover text-center">
                            <thead>
                            <tr>
                                <th scope="col" class="text-center">ردیف</th>
                                <th scope="col" class="text-center">کد</th>
                                <th scope="col" class="text-center">تعداد</th>
                                <th scope="col" class="text-center">کیلووات</th>
                                <th scope="col" class="text-center">سرعت</th>
                                <th scope="col" class="text-center">ولتاژ</th>
                                <th scope="col" class="text-center">ملاحظات</th>
                                <th scope="col" class="text-center">قیمت واحد</th>
                                <th scope="col" class="text-center">مجموع قیمت</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for index, object in nested.items %}
                                {% if object.obj.price and object.obj.qty %}
                                    <tr>
                                        <th scope="row" class="text-center">{{ forloop.counter }}</th>
                                        <td>{{ object.obj.pk }}</td>
                                        <td>{{ object.obj.qty }}</td>
                                        <td>{{ object.obj.kw }}</td>
                                        <td>{{ object.obj.rpm }}</td>
                                        <td>{{ object.obj.voltage }}</td>
                                        <td>{{ object.obj.considerations }}</td>
                                        <td>{{ object.obj.price|intcomma:0 }}</td>
                                        <td>{{ object.spec_total|intcomma:0 }}</td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                            <tr style="border-top: 2px black solid">
                                <td colspan="3">مالیات ارزش افزوده</td>
                                <td colspan="5"></td>
                                <td class="amount-total ">{{ vat | floatformat:1 | intcomma }}</td>
                            </tr>
                            <tr style="border-top: 2px black solid">
                                <td colspan="3" class="emphsize">مجموع</td>
                                <td class="kw-total emphsize">{{ kw_total|intcomma }} کیلووات</td>
                                <td colspan="4"></td>
                                <td class="amount-total emphsize">{{ proforma_total | floatformat:1 | intcomma }}</td>
                            </tr>
                            </tbody>


                        </table>
                    </div>

                    {#        Images#}
                    <div class="row">
                        <div class="col-md-10 col-md-offset-1">
                            {% for img in prof_images %}
                                <a href="{{ img.image.url }}" target="_blank">
                                    <img class="img-responsive img-thumbnail col-md-3"
                                         src="{{ img.image.url }}" style="">
                                </a>
                            {% endfor %}
                        </div>


                    </div>
                    {#        Payments#}
                    <div class="row">
                        <h4>مبالغ دریافتی بابت این پیش فاکتور:</h4>
                        <div class="col-xs-12 col-sm-6 col-md-4">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <td>شماره</td>
                                        <td>تاریخ</td>
                                        <td>مبلغ</td>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for pay in pref.payment_set.all %}
                                        <tr>
                                            <td><a href="{% url 'payment_details' ypayment_pk=pay.pk %}">
                                                {{ pay.number }}
                                            </a>
                                            </td>
                                            <td><a href="{% url 'payment_details' ypayment_pk=pay.pk %}">
                                                {{ pay.date_fa }}
                                            </a>
                                            </td>
                                            <td><a href="{% url 'payment_details' ypayment_pk=pay.pk %}">
                                                {{ pay.amount | floatformat:0 | intcomma }}
                                            </a>
                                            </td>

                                        </tr>
                                    {% endfor %}

                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>

                </div>
            </div>

        </div>

    </div>

{% endblock %}